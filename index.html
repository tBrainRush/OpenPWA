<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1e1e1e">
    <title>OpenPWA</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.js"
        integrity="sha512-JyCZjCOZoyeQZSd5+YEAcFgz2fowJ1F1hyJOXgtKu4llIa0KneLcidn5bwfutiehUTiOuK87A986BZJMko0eWQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.css"
        integrity="sha512-UtLOu9C7NuThQhuXXrGwx9Jb/z9zPQJctuAgNUBK3Z6kkSYT9wJ+2+dh6klS+TDBCV9kNPBbAxbVD+vCcfGPaA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            background-color: #1e1e1e;
            color: #fff;
        }

        header {
            background-color: #252526;
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            flex-shrink: 0;
        }

        header h1 {
            font-size: 1.5rem;
            margin: 0;
        }

        header .buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        header button {
            background-color: #0e639c;
            color: #fff;
            border: none;
            padding: 6px 10px;
            cursor: pointer;
            border-radius: 5px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 5px;
            white-space: nowrap;
        }

        header button:hover {
            background-color: #1177bb;
        }

        header button.run-button {
            background-color: #4CAF50;
        }

        header button.install-button {
            background-color: #FFA500;
        }

        #language-select {
            background-color: #333;
            color: #fff;
            border: 1px solid #444;
            border-radius: 5px;
            padding: 6px 10px;
            font-size: 0.8rem;
            cursor: pointer;
        }

        #language-select:hover {
            border-color: #0e639c;
        }

        .editor-container {
            flex: 1;
            display: flex;
            overflow: hidden;
            position: relative;
        }

        #editor {
            flex: 1;
            height: 100%;
        }

        #preview-container {
            display: none;
            flex-direction: column;
            background-color: #fff;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
        }

        #preview-container.visible {
            display: flex;
        }

        #preview-header {
            background-color: #252526;
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            cursor: ns-resize;
        }

        #preview-header button {
            background-color: #ff4d4d;
            color: #fff;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 5px;
        }

        #preview-header button:hover {
            background-color: #ff6666;
        }

        iframe {
            flex: 1;
            border: none;
            background-color: #fff;
        }

        #console {
            background-color: #1e1e1e;
            color: #fff;
            padding: 10px;
            font-family: monospace;
            font-size: 14px;
            overflow-y: auto;
            height: 200px;
            border-top: 2px solid #0e639c;
            resize: vertical;
            overflow: auto;
            display: none;
        }

        #console.visible {
            display: block;
        }

        .console-log {
            color: #fff;
        }

        .console-error {
            color: #ff4d4d;
        }

        .console-warn {
            color: #ffcc00;
        }

        .console-info {
            color: #0e639c;
        }

        .copy-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #4CAF50;
            color: white;
            padding: 15px 30px;
            border-radius: 8px;
            display: none;
            z-index: 3000;
            text-align: center;
            font-size: 16px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .copy-popup.visible {
            display: block;
        }

        .install-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .install-modal.visible {
            display: flex;
        }

        .modal-content {
            background: #252526;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .modal-row {
            margin: 15px 0;
        }

        .modal-row label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #fff;
        }

        .modal-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #444;
            border-radius: 4px;
            background-color: #333;
            color: #fff;
            font-size: 14px;
        }

        .modal-input:focus {
            border-color: #0e639c;
            outline: none;
        }

        textarea.modal-input {
            resize: vertical;
            min-height: 100px;
        }

        #icon-preview {
            width: 100%;
            max-height: 200px;
            object-fit: contain;
            margin: 10px 0;
            border-radius: 4px;
        }

        #crop-container {
            width: 100%;
            height: 300px;
            background: #1e1e1e;
            margin: 10px 0;
            display: none;
            overflow: hidden;
            border-radius: 4px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-buttons button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }

        .modal-buttons .confirm {
            background: #4CAF50;
            color: white;
        }

        .modal-buttons .confirm:hover {
            background: #45a049;
        }

        .modal-buttons .cancel {
            background: #ff4d4d;
            color: white;
        }

        .modal-buttons .cancel:hover {
            background: #e04444;
        }
    </style>
</head>

<body>
    <header>
        <h1>OpenPWA</h1>
        <div class="buttons">
            <button onclick="saveFile()">
                <span class="material-icons">save</span>
                <span data-translate="save">Salva</span>
            </button>
            <button onclick="loadFile()">
                <span class="material-icons">folder_open</span>
                <span data-translate="load">Carica</span>
            </button>
            <button onclick="selectAll()">
                <span class="material-icons">select_all</span>
                <span data-translate="select_all">Seleziona tutto</span>
            </button>
            <button onclick="undo()">
                <span class="material-icons">undo</span>
                <span data-translate="undo">Annulla</span>
            </button>
            <button onclick="redo()">
                <span class="material-icons">redo</span>
                <span data-translate="redo">Ripristina</span>
            </button>
            <button onclick="togglePreview()" class="run-button" title="Esegui">
                <span class="material-icons">play_arrow</span>
            </button>
            <button onclick="installApp()" class="install-button" title="Installa">
                <span class="material-icons">get_app</span>
            </button>
            <button onclick="openUrlModal()" class="install-button" title="PWA da URL">
                <span class="material-icons">link</span>
                <span data-translate="pwa_from_url">PWA da URL</span>
            </button>
            <select id="language-select" onchange="changeLanguage()">
                <option value="it">Italiano</option>
                <option value="en">English</option>
                <option value="es">Español</option>
                <option value="fr">Français</option>
            </select>
        </div>
    </header>
    <div class="editor-container">
        <div id="editor"></div>
    </div>

    <div id="preview-container">
        <div id="preview-header" onmousedown="startResize(event)">
            <span data-translate="preview">Anteprima</span>
            <div>
                <button onclick="toggleConsole()" data-translate="toggle_console">Mostra/Nascondi Console</button>
                <button onclick="togglePreview()" data-translate="close">Chiudi</button>
            </div>
        </div>
        <iframe id="preview"></iframe>
        <div id="console"></div>
    </div>

    <div class="install-modal" id="installModal">
        <div class="modal-content">
            <div class="modal-row">
                <label for="appTitle" data-translate="app_title">Titolo Applicazione:</label>
                <input type="text" id="appTitle" class="modal-input" placeholder="Inserisci il titolo">
            </div>

            <div class="modal-row">
                <label for="appDescription" data-translate="app_description">Descrizione Applicazione:</label>
                <textarea id="appDescription" class="modal-input" placeholder="Inserisci una descrizione"></textarea>
            </div>

            <div class="modal-row">
                <label for="iconInput" data-translate="app_icon">Icona Applicazione:</label>
                <input type="file" id="iconInput" accept="image/*">
                <div id="crop-container"></div>
                <img id="icon-preview" src="#" alt="Anteprima icona">
            </div>

            <div class="modal-row" id="urlRow" style="display: none;">
                <label for="appUrl" data-translate="app_url">URL Applicazione:</label>
                <input type="text" id="appUrl" class="modal-input" placeholder="Inserisci l'URL">
            </div>

            <div class="modal-buttons">
                <button class="confirm" onclick="processInstallation('install')"
                    data-translate="install">Installa</button>
                <button class="share" onclick="processInstallation('share')" data-translate="share">Condividi</button>
                <button class="cancel" onclick="closeInstallModal()" data-translate="cancel">Annulla</button>
            </div>
        </div>
    </div>

    <div class="copy-popup" id="copyPopup" data-translate="copied">Copiato!</div>

    <script src="https://unpkg.com/monaco-editor@0.33.0/min/vs/loader.js"></script>
    <script defer>
        window.onbeforeunload = function () { return true }
        const translations = {
            it: {
                save: "Salva",
                load: "Carica",
                select_all: "Seleziona tutto",
                undo: "Annulla",
                redo: "Ripristina",
                preview: "Anteprima",
                toggle_console: "Mostra/Nascondi Console",
                close: "Chiudi",
                app_title: "Titolo Applicazione:",
                app_description: "Descrizione Applicazione:",
                app_icon: "Icona Applicazione:",
                install: "Installa",
                share: "Condividi",
                cancel: "Annulla",
                copied: "Copiato!",
                pwa_from_url: "PWA da URL",
                app_url: "URL Applicazione:"
            },
            en: {
                save: "Save",
                load: "Load",
                select_all: "Select All",
                undo: "Undo",
                redo: "Redo",
                preview: "Preview",
                toggle_console: "Show/Hide Console",
                close: "Close",
                app_title: "App Title:",
                app_description: "App Description:",
                app_icon: "App Icon:",
                install: "Install",
                share: "Share",
                cancel: "Cancel",
                copied: "Copied!",
                pwa_from_url: "PWA from URL",
                app_url: "App URL:"
            },
            es: {
                save: "Guardar",
                load: "Cargar",
                select_all: "Seleccionar todo",
                undo: "Deshacer",
                redo: "Rehacer",
                preview: "Vista previa",
                toggle_console: "Mostrar/Ocultar Consola",
                close: "Cerrar",
                app_title: "Título de la Aplicación:",
                app_description: "Descripción de la Aplicación:",
                app_icon: "Icono de la Aplicación:",
                install: "Instalar",
                share: "Compartir",
                cancel: "Cancelar",
                copied: "¡Copiado!",
                pwa_from_url: "PWA desde URL",
                app_url: "URL de la Aplicación:"
            },
            fr: {
                save: "Enregistrer",
                load: "Charger",
                select_all: "Tout sélectionner",
                undo: "Annuler",
                redo: "Rétablir",
                preview: "Aperçu",
                toggle_console: "Afficher/Masquer la Console",
                close: "Fermer",
                app_title: "Titre de l'Application:",
                app_description: "Description de l'Application:",
                app_icon: "Icône de l'Application:",
                install: "Installer",
                share: "Partager",
                cancel: "Annuler",
                copied: "Copié!",
                pwa_from_url: "PWA depuis URL",
                app_url: "URL de l'Application:"
            }
        };

        let currentLanguage = 'it';

        function changeLanguage() {
            const languageSelect = document.getElementById('language-select');
            currentLanguage = languageSelect.value;
            translatePage();
        }

        function translatePage() {
            const elements = document.querySelectorAll('[data-translate]');
            elements.forEach(element => {
                const key = element.getAttribute('data-translate');
                element.textContent = translations[currentLanguage][key];
            });
        }

        function getStoreKey(domain) {
            return `crossDomainStore::${domain}`;
        }

        function readStore(domain) {
            let key = getStoreKey(domain);
            let store = window.localStorage.getItem(key);
            return store ? JSON.parse(store) : {};
        }

        function writeStore(domain, store) {
            let key = getStoreKey(domain);
            let serializedData = JSON.stringify(store);
            window.localStorage.setItem(key, serializedData);
        }

        function openDatabase() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('EditorDB', 1);

                request.onupgradeneeded = function (event) {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('editorState')) {
                        db.createObjectStore('editorState', { keyPath: 'id' });
                    }
                };

                request.onsuccess = function (event) {
                    resolve(event.target.result);
                };

                request.onerror = function (event) {
                    reject('Errore nell\'apertura del database');
                };
            });
        }

        async function saveEditorState(state) {
            const db = await openDatabase();
            const transaction = db.transaction('editorState', 'readwrite');
            const store = transaction.objectStore('editorState');

            const request = store.put({ id: 'currentState', state });

            return new Promise((resolve, reject) => {
                request.onsuccess = () => resolve();
                request.onerror = () => reject('Errore nel salvataggio dello stato');
            });
        }

        async function loadEditorState() {
            const db = await openDatabase();
            const transaction = db.transaction('editorState', 'readonly');
            const store = transaction.objectStore('editorState');

            const request = store.get('currentState');

            return new Promise((resolve, reject) => {
                request.onsuccess = () => resolve(request.result ? request.result.state : null);
                request.onerror = () => reject('Errore nel caricamento dello stato');
            });
        }

        require.config({ paths: { 'vs': 'https://unpkg.com/monaco-editor@0.33.0/min/vs' } });
        require(['vs/editor/editor.main'], function () {
            window.editor = monaco.editor.create(document.getElementById('editor'), {
                value: `<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            color: #333;
            margin: 0;
            padding: 20px;
        }
        h1 {
            color: #0e639c;
        }
    </style>
</head>
<body>
    <h1>Ciao, Mondo!</h1>
    <script>
        console.log('Hello, World!');
        console.error('Errore di esempio');
        console.warn('Avviso di esempio');
        console.info('Messaggio informativo');
    <\/script>
</body>
</html>`,
                language: 'html',
                theme: 'vs-dark',
            });

            window.editor.onDidChangeModelContent(() => {
                const state = window.editor.getValue();
                saveEditorState(state).then(() => {
                    console.log('Stato dell\'editor salvato con successo.');
                }).catch((error) => {
                    console.error('Errore nel salvataggio dello stato:', error);
                });
            });

            loadEditorState().then((state) => {
                if (state) {
                    window.editor.setValue(state);
                }
            }).catch((error) => {
                console.error('Errore nel caricamento dello stato:', error);
            });
        });

        let cropper = null;
        let selectedFile = null;
        const defaultIconUrl = "https://cdn-icons-png.flaticon.com/512/123/123456.png";
        var canvas = null;

        function installApp() {
            document.getElementById('installModal').classList.add('visible');
            document.getElementById('appTitle').value = 'My PWA';
            document.getElementById('icon-preview').style.display = 'none';
            document.getElementById('crop-container').style.display = 'block';

            if (!selectedFile) {
                loadDefaultIcon();
            }
        }

        function loadDefaultIcon() {
            const image = document.createElement('img');
            image.id = 'crop-image';
            image.src = defaultIconUrl;

            const container = document.getElementById('crop-container');
            container.innerHTML = '';
            container.appendChild(image);

            if (cropper) cropper.destroy();

            cropper = new Cropper(image, {
                aspectRatio: 1,
                viewMode: 2,
                autoCropArea: 1,
                responsive: true,
                guides: false,
                zoomable: false,
                scalable: false,
                cropBoxResizable: false,
            });
        }

        document.getElementById('iconInput').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (!file) return;

            selectedFile = file;
            const reader = new FileReader();

            reader.onload = function (event) {
                const image = document.createElement('img');
                image.id = 'crop-image';
                image.src = event.target.result;

                const container = document.getElementById('crop-container');
                container.innerHTML = '';
                container.appendChild(image);

                if (cropper) cropper.destroy();

                cropper = new Cropper(image, {
                    aspectRatio: 1,
                    viewMode: 2,
                    autoCropArea: 1,
                    responsive: true,
                    guides: false,
                    zoomable: false,
                    scalable: false,
                    cropBoxResizable: false,
                });
            };

            reader.readAsDataURL(file);
        });

        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                var r = Math.random() * 16 | 0,
                    v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        async function processInstallation(action) {
            try {
                const appTitle = document.getElementById('appTitle').value.trim();
                const appDescription = document.getElementById('appDescription').value.trim();
                const appUrl = document.getElementById('appUrl').value.trim();

                if (!appTitle) {
                    alert(translations[currentLanguage]['app_title'] + ' ' + translations[currentLanguage]['required']);
                    return;
                }

                let code = window.editor.getValue();
                if (appUrl) {
                    code = appUrl;
                }

                let iconData = null;
                if (cropper) {
                    const croppedCanvas = cropper.getCroppedCanvas({
                        width: 512,
                        height: 512,
                    });

                    if (croppedCanvas) {
                        iconData = croppedCanvas.toDataURL('image/png').replace(/^data:image\/png;base64,/, '');
                    } else {
                        alert(translations[currentLanguage]['crop_error']);
                        return;
                    }
                } else {
                    const response = await fetch(defaultIconUrl);
                    const blob = await response.blob();
                    iconData = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = () => {
                            resolve(reader.result.replace(/^data:image\/(png|jpeg);base64,/, ''));
                        };
                        reader.onerror = () => {
                            reject(new Error(translations[currentLanguage]['icon_error']));
                        };
                        reader.readAsDataURL(blob);
                    });
                }

                const mobileConfig = `<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>PayloadContent</key>
    <array>
        <dict>
            <key>FullScreen</key>
            <true/>
            <key>Icon</key>
            <data>${iconData}</data>
            <key>IsRemovable</key>
            <true/>
            <key>Label</key>
            <string>${appTitle}</string>
            <key>PayloadDescription</key>
            <string>${appDescription || translations[currentLanguage]['no_description']}</string>
            <key>PayloadDisplayName</key>
            <string>Web Clip (${appTitle})</string>
            <key>PayloadIdentifier</key>
            <string>${appTitle}</string>
            <key>PayloadOrganization</key>
            <string>Me</string>
            <key>PayloadType</key>
            <string>com.apple.webClip.managed</string>
            <key>PayloadUUID</key>
            <string>${generateUUID()}</string>
            <key>PayloadVersion</key>
            <integer>1</integer>
            <key>Precomposed</key>
            <false/>
            <key>URL</key>
            <string>${appUrl ? appUrl : `data:text/html,${encodeURIComponent(code)}`}</string>
        </dict>
    </array>
    <key>PayloadDescription</key>
    <string>${appDescription || translations[currentLanguage]['no_description']}</string>
    <key>PayloadDisplayName</key>
            <string>${appTitle}</string>
            <key>PayloadIdentifier</key>
            <string>${appTitle}</string>
            <key>PayloadOrganization</key>
            <string>Me</string>
            <key>PayloadRemovalDisallowed</key>
            <false/>
            <key>PayloadType</key>
            <string>Configuration</string>
            <key>PayloadUUID</key>
            <string>${generateUUID()}</string>
            <key>PayloadVersion</key>
            <integer>1</integer>
        </dict>
        </plist>`;

                const mobileConfigWithoutLineBreaks = mobileConfig.replace(/\n/g, '');
                const base64Config = btoa(unescape(encodeURIComponent(mobileConfigWithoutLineBreaks)));
                const url = `data:application/x-apple-aspen-config;base64,${base64Config}`;

                if (action === 'install') {
                    openInSafari(url);
                } else if (action === 'share') {
                    copyToClipboard(url);
                    showCopyPopup();
                }
            } catch (error) {
                console.error("Errore durante l'installazione:", error);
                alert(`Si è verificato un errore durante l'installazione:\n\n${error.message}`);
            } finally {
                closeInstallModal();
            }
        }

        function copyToClipboard(string) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                return navigator.clipboard.writeText(string)
                    .then(() => {
                        console.log("Testo copiato con l'API Clipboard!");
                        return true;
                    })
                    .catch((err) => {
                        console.error("Errore con l'API Clipboard, utilizzo il fallback:", err);
                        return copyToClipboardFallback(string);
                    });
            } else {
                return copyToClipboardFallback(string);
            }
        }

        function copyToClipboardFallback(string) {
            let textarea;
            let result;

            try {
                textarea = document.createElement('textarea');
                textarea.setAttribute('readonly', true);
                textarea.setAttribute('contenteditable', true);
                textarea.style.position = 'fixed';
                textarea.value = string;

                document.body.appendChild(textarea);

                textarea.focus();
                textarea.select();

                const range = document.createRange();
                range.selectNodeContents(textarea);

                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(range);

                textarea.setSelectionRange(0, textarea.value.length);
                result = document.execCommand('copy');
            } catch (err) {
                console.error("Errore durante il fallback:", err);
                result = false;
            } finally {
                if (textarea) {
                    document.body.removeChild(textarea);
                }
            }

            if (!result) {
                const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
                const copyHotkey = isMac ? '⌘C' : 'CTRL+C';
                result = prompt(`Premi ${copyHotkey} per copiare:`, string);
                if (!result) {
                    return false;
                }
            }

            return true;
        }

        function showCopyPopup() {
            const popup = document.getElementById('copyPopup');
            popup.classList.add('visible');
            setTimeout(() => {
                popup.classList.remove('visible');
            }, 2000);
        }

        function openInSafari(url) {
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

            if (isIOS) {
                const form = document.createElement('form');
                form.action = url;
                form.method = 'POST';
                form.style.display = 'none';

                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'dummy';
                input.value = '1';
                form.appendChild(input);

                document.body.appendChild(form);
                form.submit();

                document.body.removeChild(form);
            } else {
                window.open(url, '_blank');
            }
        }

        function closeInstallModal() {
            document.getElementById('installModal').classList.remove('visible');
        }

        function saveFile() {
            const content = window.editor.getValue();
            const blob = new Blob([content], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'code.html';
            a.click();
            URL.revokeObjectURL(url);
        }

        function loadFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.txt,.html,.css,.js';
            input.onchange = (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const content = e.target.result;
                        window.editor.setValue(content);
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        function selectAll() {
            window.editor.setSelection(window.editor.getModel().getFullModelRange());
        }

        function undo() {
            window.editor.getModel().undo();
        }

        function redo() {
            window.editor.getModel().redo();
        }

        let isResizing = false;
        function startResize(event) {
            isResizing = true;
            document.addEventListener('mousemove', resizePreview);
            document.addEventListener('mouseup', stopResize);
        }

        function resizePreview(event) {
            if (isResizing) {
                const previewContainer = document.getElementById('preview-container');
                const height = window.innerHeight - event.clientY;
                previewContainer.style.height = `${height}px`;
            }
        }

        function stopResize() {
            isResizing = false;
            document.removeEventListener('mousemove', resizePreview);
            document.removeEventListener('mouseup', stopResize);
        }

        function togglePreview() {
            const previewContainer = document.getElementById('preview-container');
            const isVisible = previewContainer.classList.contains('visible');

            if (isVisible) {
                previewContainer.classList.remove('visible');
            } else {
                const code = window.editor.getValue();
                const preview = document.getElementById('preview');
                preview.srcdoc = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <script>
                            // Override console methods to send messages to the parent window
                            const originalConsole = {
                                log: console.log,
                                error: console.error,
                                warn: console.warn,
                                info: console.info
                            };

                            function sendConsoleMessage(type, message) {
                                window.parent.postMessage({ type, message }, '*');
                            }

                            console.log = function(...args) {
                                originalConsole.log(...args);
                                sendConsoleMessage('log', args.join(' '));
                            };

                            console.error = function(...args) {
                                originalConsole.error(...args);
                                sendConsoleMessage('error', args.join(' '));
                            };

                            console.warn = function(...args) {
                                originalConsole.warn(...args);
                                sendConsoleMessage('warn', args.join(' '));
                            };

                            console.info = function(...args) {
                                originalConsole.info(...args);
                                sendConsoleMessage('info', args.join(' '));
                            };
                        <\/script>
                    </head>
                    <body>
                        ${code}
                    </body>
                    </html>
                `;
                previewContainer.classList.add('visible');
            }
        }

        function toggleConsole() {
            const consoleElement = document.getElementById('console');
            consoleElement.classList.toggle('visible');
        }

        window.addEventListener('message', function (event) {
            const { type, message } = event.data;
            const consoleElement = document.getElementById('console');
            const messageElement = document.createElement('div');
            messageElement.classList.add(`console-${type}`);
            messageElement.textContent = message;
            consoleElement.appendChild(messageElement);
            consoleElement.scrollTop = consoleElement.scrollHeight;
        });

        function openUrlModal() {
            document.getElementById('installModal').classList.add('visible');
            document.getElementById('appTitle').value = 'My PWA';
            document.getElementById('icon-preview').style.display = 'none';
            document.getElementById('crop-container').style.display = 'block';
            document.getElementById('urlRow').style.display = 'block';
            document.getElementById('appUrl').value = '';

            if (!selectedFile) {
                loadDefaultIcon();
            }
        }

        translatePage();
    </script>


</body>

</html>
